<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <title>Etiquetas {% if session['id_page'] %} {{'(' + session['id_page'] + ')' }} {% endif %} | HUGO PIETRO</title>
        <link rel="icon" href="{{ url_for('static', filename='hp-logo-only.svg') }}" type="image/x-icon">

        {% include 'shared/header/hp-header.html' %}

    <!-- TABELA -->
        <div draggable="false" class="form-login">
            <div class="split-horizontal">
                <div class="log">
                    <div class="split-horizontal">
                        <h1 class="title">Emissor de Etiquetas <span class="id-page">{{session['id_page']}}</h1>
                    </div>
                    <div style="max-width: 400px; justify-content: flex-start; margin: auto">
                        <div>
                            <form id="formBuscarItens" method="post" onsubmit="lockIcoShow()">

                                <label for="cod_str_qr"></label>
                                <div class="split-horizontal">
                                    <input type="text" style="width: 320px;" id="cod_str_qr" maxlength="14" name="cod_str_qr" required placeholder="Leia o QR-Code ou o DUN-14...">
                                    <input class="subm" style="width: 42px; height: 42px; margin-left: 4px; padding: 8px;" type="image" src="{{ url_for('static', filename='svg/scan-barcode.svg') }}" alt="">
                                </div>
                                <hr>
                            </form>
                        </div>
                        <form style="display: flex; justify-content: flex-start" id="field" method="post" action="{{ url_for('etiqueta') }}">
                            <div>
                                <label for="produto">Produto
                                    <img id="label-desc" class="svg-label" src="{{ url_for('static', filename='svg/lock.svg') }}" alt="">
                                </label><br>
                                <input name="produto" id="produto" type="text" value="{{ descITEM }}" onclick="maximizeText(this)" required readonly placeholder="Produto...">
                            </div>

                            <div class="two-split">
                                <div>
                                    <label for="codsku">CÃ³digo
                                        <img id="label-sku" class="svg-label" src="{{ url_for('static', filename='svg/lock.svg') }}" alt="">
                                    </label><br>
                                    <select class="address" id="codsku" name="codsku" required onchange="lockIcoShow()"></select>
                                </div>

                                <div>
                                    <label for="lote_item">Lote
                                        <img id="label-lote" class="svg-label" src="{{ url_for('static', filename='svg/lock.svg') }}" alt="">
                                    </label><br>
                                    <input class="address" pattern="[A-Z0-9]{6}" maxlength="6" id="lote_item" type="text" name="lote" value="{{ codLOTE }}" required readonly placeholder="Lote...">
                                </div>
                            </div>
                            <br>
                            <div style="display: flex;width: 100%;">
                                <input class="subm" style="max-width: none;" type="submit" value="Emitir Etiqueta">
                                <img class="subm" id="img_checkbox" style="height: 35px;width: 35px; padding: 12px;margin-left: 15px" src="{{ url_for('static', filename='svg/image-down.svg') }}" onclick="toggleCheckbox('img_checkbox','img_download')" alt="">
                            </div>

                            <div class="split-horizontal">
                                <input class="check_box" style="display: none" type="checkbox" id="img_download" name="img_download">
                            </div>
                        </form>
                    </div>
                </div>
                <div class="form-container" id="tables-cont" style="max-width: 580px;margin: 10px; margin-left: 40px;">
                    <img class="svg-none" src="{{ url_for('static', filename='svg/tags.svg') }}" alt="">
                    <div class="centralizado">
                        <div class="centralizado" style="background-color: #4373b6; border-radius: 20px; width: 450px; height: 450px;">
                            <img id="qrCodeImage" style="border-radius: 10px;" src="" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>

            $("#formBuscarItens").submit(function(event) {
                event.preventDefault();
                var codigo = $("#cod_str_qr").val();
                
                buscarItens(codigo);
            });

            $("#codsku").change(function(event) {
                event.preventDefault();
                var codigo = $("#codsku").val();
                
                buscarItens(codigo);
            });

            function buscarItens(codigo) {

                $.ajax({
                    type: "POST",
                    url: "/searching",
                    data: { cod_str_qr: codigo },
                    success: function(response) {

                        $("#produto").val(response.descITEM);
                        $("#cod_str_qr").val("");
                        $("#codsku").empty();

                        if (response.codITEM.length > 1) {
                            lockIcoHide("label-sku");
                        }

                        if (response.codITEM) {
                            response.codITEM.forEach(function(item) {
                                $("#codsku").append("<option value='" + item + "'>" + item + "</option>");
                            });
                        } else {
                            $("#codsku").append("<option value=''></option>");
                        }

                        $("#lote_item").val(response.codLOTE);

                        if (response.codLOTE === "") {
                            lockIcoHide("label-lote")
                            $("#lote_item").prop("readonly", false);
                        } else {
                            $("#lote_item").prop("readonly", true);
                        }
                    },
                    error: function(error) {
                        console.error("Erro ao buscar itens:", error);
                    }
                });
            }

            document.getElementById("field").addEventListener("submit", function() {
                document.getElementById("submitform").disabled = true;
            });

                $("#field").submit(function(event) {
                     event.preventDefault();

                     var qr_text = $("#codsku").val() + ";" + $("#lote_item").val();
                     var produto = $("#produto").val();
                     var codsku = $("#codsku").val();
                     var lote_item = $("#lote_item").val();
                     var check = $("#img_download").prop('checked');

                     exibirQRCode(qr_text, produto, lote_item, codsku, check);

                });

                function exibirQRCode(qr_text, produto, lote_item, codsku, check) {
                    $.ajax({
                        type: "POST",
                        url: "/etiqueta",
                        data: { qr_text: qr_text, produto: produto, lote_item: lote_item, codsku: codsku, check: check },
                        success: function(response) {
                            if (check === false) {
                                $("#qrCodeImage").attr("src", "data:image/img;base64," + response);
                            }
                            else {
                                $("#qrCodeImage").attr("src", "data:image/img;base64," + response);

                                var link = document.createElement('a');
                                link.href = "data:image/img;base64," + response;
                                link.download = qr_text + ".png";
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                        },
                        error: function(error) {
                            console.error("Erro ao exibir QR Code:", error);
                        }
                    });
                }

    </script>



    {% include 'shared/footer.html' %}