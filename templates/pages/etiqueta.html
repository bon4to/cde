<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <title>Etiquetas | TRANS LÃ‰GUA</title>

        {% include 'shared/header.html' %}

    <!-- TABELA -->
        <div draggable="false" class="form-login">
            <div class="split-horizontal">
                <div>
                    <div class="split-horizontal">
                        <h1>Etiquetas</h1>
                    </div>

                    <div>
                        <div>
                            <form id="formBuscarItens" method="post" onsubmit="lockIcoShow()">
                                <hr>
                                <label for="cod_str_qr"></label>
                                <div class="split-horizontal">
                                    <input type="text" style="width: 320px;" id="cod_str_qr" maxlength="14" name="cod_str_qr" required placeholder="Leia o QR-Code ou o DUN-14...">
                                    <input class="subm" style="width: 42px; height: 42px; margin-left: 4px; padding: 8px;" type="image" src="{{ url_for('static', filename='icons/scan-barcode.svg') }}" alt="">
                                </div>
                                <hr>
                            </form>
                        </div>
                        <div id="resultadoBusca"></div>
                        <form style="display: flex;" id="field" method="post" action="{{ url_for('etiqueta') }}">

                            <label for="produto">Produto
                                <img id="label-desc" class="svg-label" src="{{ url_for('static', filename='icons/lock.svg') }}" alt=""><br>
                            </label>

                            <input name="produto" id="produto" type="text" value="{{ descITEM }}" required readonly placeholder="Produto...">
                            <div class="split-horizontal">
                                <div>
                                    <label for="codsku1" >SKU
                                        <img id="label-sku" class="svg-label" src="{{ url_for('static', filename='icons/lock.svg') }}" alt="">
                                    </label><br>

                                    <select class="address" id="codsku1" name="codinterno" required>
                                    </select>
                                </div>

                                <div>
                                    <label for="lote1" >Lote
                                        <img id="label-lote" class="svg-label" src="{{ url_for('static', filename='icons/lock.svg') }}" alt="">
                                    </label><br>

                                    <input class="address" pattern="[A-Z0-9]{6}" maxlength="6" id="lote1" type="text" name="lote" value="{{ codLOTE }}" required readonly placeholder="Lote...">
                                </div>
                            </div>
                            <hr>

                            <div class="split-horizontal">
                                <input class="subm" type="submit" style="width: 320px; max-width: none;height: 52px; margin-right: 12px; padding: 8px" value="Emitir Etiqueta">
                                <img class="subm" id="img_checkbox" style="width: 52px; height: 52px; padding: 0" src="{{ url_for('static', filename='icons/download-button.svg') }}" onclick="toggleCheckbox()" alt="">
                            </div>
                            <div class="split-horizontal">
                                <input class="check_box" style="display: none" type="checkbox" id="img_download" name="img_download">
                            </div>
                        </form>
                    </div>
                </div>
                <div class="form-container" id="tables-cont" style="max-width: 580px;margin: 10px; margin-left: 40px;">
                    <img class="svg-none" src="{{ url_for('static', filename='icons/tags.svg') }}" alt="">
                    <div class="centralizado">
                        <div class="centralizado" style="background-color: #4373b6; border-radius: 20px; width: 450px; height: 450px;">
                            <img id="qrCodeImage" style="border-radius: 10px;" src="" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>

            $("#formBuscarItens").submit(function(event) {
                event.preventDefault();
                buscarItens();
            });

            function buscarItens() {
                var codigo = $("#cod_str_qr").val();

                $.ajax({
                    type: "POST",
                    url: "/searching",
                    data: { cod_str_qr: codigo },
                    success: function(response) {

                        $("#produto").val(response.descITEM);
                        $("#cod_str_qr").val("");
                        $("#codsku1").empty();

                        if (response.codITEM.length > 1) {
                            lockIcoHide("label-sku");
                        }

                        if (response.codITEM) {
                            response.codITEM.forEach(function(item) {

                                $("#codsku1").append("<option value='" + item + "'>" + item + "</option>");
                            });
                        } else {
                            $("#codsku1").append("<option value=''></option>");
                        }

                        $("#lote1").val(response.codLOTE);

                        if (response.codLOTE === "") {
                            lockIcoHide("label-lote")

                            $("#lote1").prop("readonly", false);
                        } else {

                            $("#lote1").prop("readonly", true);
                        }
                    },

                    error: function(error) {
                        console.error("Erro ao buscar itens:", error);
                    }
                });
            }


                $("#field").submit(function(event) {
                     event.preventDefault();

                     var qr_text = $("#codsku1").val() + ";" + $("#lote1").val();
                     var desc = $("#produto").val();
                     var sku = $("#codsku1").val();
                     var lote = $("#lote1").val();
                     var check = $("#img_download").prop('checked');

                     exibirQRCode(qr_text, desc, lote, sku, check);

                });

                function exibirQRCode(qr_text, desc, lote, sku, check) {
                    $.ajax({
                        type: "POST",
                        url: "/etiqueta",
                        data: { qr_text: qr_text, desc: desc, lote: lote, sku: sku, check: check },
                        success: function(response) {
                            if (check === false) {
                                $("#qrCodeImage").attr("src", "data:image/png;base64," + response);
                            }
                            else {
                                $("#qrCodeImage").attr("src", "data:image/png;base64," + response);

                                var link = document.createElement('a');
                                link.href = "data:image/png;base64," + response;
                                link.download = qr_text + ".png";
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                        },
                        error: function(error) {
                            console.error("Erro ao exibir QR Code:", error);
                        }
                    });
                }

    </script>



    {% include 'shared/footer.html' %}