{% extends "pages/estoque.j2" %}

    {% block svg %}
        <a class="aux-button {% if request.endpoint == 'estoque' %}active{% endif %}">
            <img class="svg-gray" src="{{ url_for('static', filename='svg/group.svg') }}" title="ESTOQUE" alt="" onclick="window.location.href='{{ url_for('estoque') }}';">
        </a>
        <a class="aux-button {% if request.endpoint == 'estoque_enderecado' %}active{% endif %}">
            <img class="svg-gray" src="{{ url_for('static', filename='svg/land-plot.svg') }}" title="ESTOQUE (ENDEREÇADO)" alt="" onclick="window.location.href='{{ url_for('estoque_enderecado') }}';">
        </a>
            <a class="aux-button {% if request.endpoint == 'estoque_preset' %}active{% endif %}">
            <img class="svg-gray" src="{{ url_for('static', filename='svg/blend.svg') }}" title="ESTOQUE (PRESET)" alt="" onclick="window.location.href='{{ url_for('estoque_preset') }}';">
        </a>
    {% endblock svg %}

    {% block table %}
        {% if search_term %}
            <div class="split-h">
                <h1 style="font-size: 22px">Estoque na data <span class="text-main-color">{{ search_term }}</span>.</h1>
                <a class="button-mini btn-fancy" style="margin: 0" onclick="window.location.href='{{ url_for('estoque_enderecado') }}';" title="Limpar">
                    <img class="svg-invert" src="{{ url_for('static', filename='svg/eraser.svg') }}" alt="">
                </a>
            </div>
        {% endif %}
        <div class="table-overflow">
            <table id="filterTable">
                <thead>
                    <tr>
                        <th>Endereço</th>
                        <th>Item (Código)</th>
                        <th>Item (Descrição)</th>
                        <th>Lote (Código)</th>
                        <th colspan="2">Validade (Dias)</th>
                        <th>QTDE</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inv_data %}
                        <tr class="selectable-row" data-item-index="{{ loop.index0 }}">
                            <td>{{ item['address'] }} </td>
                            <td class="number">{{ item['cod_item'] }}</td>
                            <td>{{ item['desc_item'] }}</td>
                            <td 
                                title="Data Fab.: {{ item['date_fab'] }}"
                                {% if 'CS' not in item['cod_lote']|string %}
                                    style="color:rgb(113, 113, 113);"
                                {% endif %}
                            >
                                {{ item['cod_lote'] }}
                            </td>
                                {% if '/' in item['validade']|string and 'CS' in item['cod_lote']%}
                                {# Validade não cadastrada #}
                                <td
                                    class="keep-color"
                                    colspan="2"
                                    style="color: red; font-weight: bold"
                                    title="Validade não informada no ERP!"
                                >
                                    -
                                </td>
                                {% elif '/' in item['validade']|string %}
                                {# N/A #}
                                    <td
                                        colspan="2"
                                        style="color:rgb(113, 113, 113);"
                                        title="Item não possui validade."
                                    >
                                    {{ item['validade'] }}
                                    </td>
                                {% else %}
                                {# A data é valida #}
                                <td
                                    class="keep-color"
                                    {% set validade_meses = item['validade'] | int / 30  %}
                                    title="{{ item['validade_str'] }} ({{ item['validade_perc_str'] }}%)"

                                    {% if item['validade_perc_str'] >= 80 %}   {# self life more than 80% #}
                                        style="color: green; font-weight: bold"
                                    {% elif item['validade_perc_str'] >= 70 %} {# self life more than 70% #}
                                        style="color: #daa520; font-weight: bold"
                                    {% else %}                                {# self life less than 70% #}
                                        style="color: red; font-weight: bold"
                                    {% endif %}
                                >
                                    {{ item['validade'] }}
                                </td>
                                <td
                                    class="keep-color"
                                    {% set validade_meses = item['validade'] | int / 30  %}
                                    title="Vida útil"

                                    {% if item['validade_perc_str'] >= 80 %}   {# self life more than 80% #}
                                        style="width: 10px; color: green; font-weight: bold; text-align: right"
                                    {% elif item['validade_perc_str'] >= 70 %} {# self life more than 70% #}
                                        style="width: 10px; color: #daa520; font-weight: bold; text-align: right"
                                    {% else %}                                {# self life less than 70% #}
                                        style="width: 10px; color: red; font-weight: bold; text-align: right"
                                    {% endif %}
                                >
                                    {{ item['validade_perc_str'] }}%
                                </td>
                                {% endif %}
                            <td class="number">{{ item['saldo'] }}.0</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Item Details Modal #}
        <div id="itemModal" class="modal-overlay" onclick="if(event.target === this) Modal.close('itemModal')">
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h2 id="modalTitle">Detalhes do Item</h2>
                    <button class="modal-close" onclick="Modal.close('itemModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-info">
                        <span class="modal-info-label">Código</span>
                        <span class="modal-info-value" id="modalCodItem"></span>
                    </div>
                    <div class="modal-info">
                        <span class="modal-info-label">Descrição</span>
                        <span class="modal-info-value" id="modalDescItem"></span>
                    </div>
                    <div class="modal-info">
                        <span class="modal-info-label">Lote</span>
                        <span class="modal-info-value" id="modalCodLote"></span>
                    </div>
                    <div class="modal-info">
                        <span class="modal-info-label">Endereço</span>
                        <span class="modal-info-value" id="modalAddress"></span>
                    </div>
                    <div class="modal-info">
                        <span class="modal-info-label">Quantidade</span>
                        <span class="modal-info-value" id="modalSaldo"></span>
                    </div>
                    <div class="modal-info">
                        <span class="modal-info-label">Validade</span>
                        <span class="modal-info-value" id="modalValidade"></span>
                    </div>

                    <hr style="margin: 16px 0; border: none; border-top: 1px solid #eee;">

                    <div class="modal-info">
                        <span class="modal-info-label">Data de Fabricação</span>
                        <span class="modal-info-value">
                            <span id="modalDateFabDisplay">-</span>
                            <span id="modalDateFabCustomBadge" class="badge-custom hidden" title="Data customizada">(editado)</span>
                        </span>
                    </div>

                    <div id="dateFabEditSection" style="margin-top: 12px; padding: 12px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="date" id="modalDateFab" style="flex: 1;">
                            <button class="modal-btn modal-btn-primary" onclick="saveDateFab()" title="Salvar">
                                <img src="{{ url_for('static', filename='svg/circle-check.svg') }}" alt="Salvar" style="width: 16px; height: 16px; filter: invert(1);">
                            </button>
                            <button id="btnClearDateFab" class="modal-btn modal-btn-secondary hidden" onclick="clearDateFab()" title="Limpar override">
                                <img src="{{ url_for('static', filename='svg/eraser.svg') }}" alt="Limpar" style="width: 16px; height: 16px;">
                            </button>
                        </div>
                        <p class="field-hint" style="margin-top: 6px; font-size: 12px; color: #888;">
                            1º movimento: <span id="modalFirstMov">-</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .badge-custom {
                font-size: 11px;
                color: var(--main-color);
                font-weight: 500;
            }
            #dateFabEditSection {
                background: #f8f8f8;
            }
            html.dark #dateFabEditSection {
                background: #333;
            }
            html.dark #dateFabEditSection input {
                background: #2a2a2a;
                border-color: #444;
                color: #eee;
            }
            html.dark #itemModal hr {
                border-top-color: #444;
            }
        </style>

        <script>
            const itemsData = {{ inv_data | tojson | safe }};
            let currentItem = null;

            // Format YYYY-MM-DD or YYYY-MM-DD HH:MM:SS to DD/MM/YYYY
            function formatDateBR(dateStr) {
                if (!dateStr || dateStr === '-') return '-';
                const datePart = dateStr.split(' ')[0];
                const parts = datePart.split('-');
                if (parts.length !== 3) return dateStr;
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            document.getElementById('filterTable').addEventListener('click', function(e) {
                const row = e.target.closest('tr[data-item-index]');
                if (row) {
                    const index = parseInt(row.dataset.itemIndex);
                    openItemModal(itemsData[index]);
                }
            });

            function openItemModal(item) {
                currentItem = item;

                document.getElementById('modalTitle').textContent = item.desc_item;
                document.getElementById('modalCodItem').textContent = item.cod_item;
                document.getElementById('modalDescItem').textContent = item.desc_item;
                document.getElementById('modalCodLote').textContent = item.cod_lote;
                document.getElementById('modalAddress').textContent = item.address.trim();
                document.getElementById('modalSaldo').textContent = item.saldo + ' un';

                let validadeText = '-';
                if (typeof item.validade === 'number') {
                    validadeText = `${item.validade} dias (${item.validade_str})`;
                } else if (item.validade) {
                    validadeText = item.validade;
                }
                document.getElementById('modalValidade').textContent = validadeText;

                document.getElementById('modalDateFabDisplay').textContent = formatDateBR(item.date_fab) || '-';
                document.getElementById('modalDateFab').value = '';
                document.getElementById('modalFirstMov').textContent = 'Carregando...';
                document.getElementById('modalDateFabCustomBadge').classList.add('hidden');
                document.getElementById('btnClearDateFab').classList.add('hidden');

                Modal.open('itemModal');

                fetch(`/api/custom_date_fab?cod_item=${encodeURIComponent(item.cod_item)}&cod_lote=${encodeURIComponent(item.cod_lote)}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('modalFirstMov').textContent = formatDateBR(data.first_mov) || '-';

                        if (data.custom_date_fab) {
                            document.getElementById('modalDateFab').value = data.custom_date_fab;
                            document.getElementById('modalDateFabCustomBadge').classList.remove('hidden');
                            document.getElementById('btnClearDateFab').classList.remove('hidden');
                        } else if (data.first_mov) {
                            document.getElementById('modalDateFab').value = data.first_mov;
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching date_fab:', err);
                        document.getElementById('modalFirstMov').textContent = 'Erro';
                    });
            }

            function saveDateFab() {
                const dateFab = document.getElementById('modalDateFab').value;
                if (!dateFab) {
                    Modal.alert('Por favor, selecione uma data.');
                    return;
                }

                fetch('/api/custom_date_fab', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cod_item: currentItem.cod_item,
                        cod_lote: currentItem.cod_lote,
                        date_fab: dateFab
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        Modal.alert(data.error || 'Erro ao salvar data de fabricação.');
                    }
                })
                .catch(err => {
                    console.error('Error saving date_fab:', err);
                    Modal.alert('Erro ao salvar data de fabricação.');
                });
            }

            function clearDateFab() {
                Modal.confirm(
                    'Remover data customizada? Voltará a usar a data do primeiro movimento.',
                    () => {
                        fetch(`/api/custom_date_fab?cod_item=${encodeURIComponent(currentItem.cod_item)}&cod_lote=${encodeURIComponent(currentItem.cod_lote)}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                window.location.reload();
                            } else {
                                Modal.alert(data.error || 'Erro ao limpar data de fabricação.');
                            }
                        })
                        .catch(err => {
                            console.error('Error clearing date_fab:', err);
                            Modal.alert('Erro ao limpar data de fabricação.');
                        });
                    },
                    { title: 'Limpar Override', confirmText: 'Limpar', danger: true }
                );
            }
        </script>
    {% endblock table %}
