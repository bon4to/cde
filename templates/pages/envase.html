<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <title>Envase | TRANS LÉGUA</title>

        {% include "shared/header.html" %}

            <div id="floating-container" draggable="false" class="form-container" style="position: relative">
                <hr>
                <div class="centralizado">
                    <div>
                        <div>
                            <form id="formBuscarItens" method="post" onsubmit="lockIcoShow()">
                                <label for="cod_str_qr"></label>
                                <div class="split-horizontal">
                                    <input type="text" style="width: 320px;" id="cod_str_qr" maxlength="14" name="cod_str_qr" required placeholder="DUN-14 ou código do item...">
                                    <input class="subm" style="width: 42px; height: 42px; margin-left: 4px; padding: 8px; transform: rotate(90deg);" type="image" src="{{ url_for('static', filename='icons/exit.svg') }}" alt="">
                                </div>
                                <hr>
                            </form>
                            <form style="display: flex;" id="field" method="post" action="/envase/insert">
                                <div>
                                    <label for="produto">Produto<img id="label-desc" class="svg-label" src="{{ url_for('static', filename='icons/lock.svg') }}" alt=""><br></label>
                                    <input name="produto" id="produto" type="text" value="{{ descITEM }}" required readonly placeholder="Produto...">
                                </div>
                                <div class="three-split">
                                    <div>
                                        <label for="codsku">SKU<img id="label-sku" class="svg-label" src="{{ url_for('static', filename='icons/lock.svg') }}" alt=""><br></label>
                                        <select id="codsku" name="codinterno" class="address-three" required></select>
                                    </div>
                                    <div>
                                        <label for="linha">Linha<img id="label-linha" class="svg-label" src="{{ url_for('static', filename='icons/lock.svg') }}" alt=""><br></label>
                                        <select name="linha" id="linha" class="address-three" required></select>
                                    </div>
                                    <div>
                                        <label for="quantidade1">Quantidade</label><br>
                                        <input class="address-three" type="number" id="quantidade1" name="quantidade" min="1" required placeholder="Quantidade...">
                                    </div>
                                </div>
                                <hr>
                                <div class="two-split">
                                    <div>
                                        <label for="data_antec">Entrada Antec.</label><br>
                                        <input name="data_antec" id="data_antec" type="date" placeholder="DD/MM/AAAA" class="address">
                                    </div>
                                    <div>
                                        <label for="data_envase">Envase</label><br>
                                        <input name="data_envase" id="data_envase" type="date" class="address">
                                    </div>
                                </div>
                                <label for="cliente">Cliente</label>
                                <div>
                                    <select name="cliente" id="cliente" class="select2">
                                        {% for item in fant_clientes %}
                                            <option value="{{ item['desc_item'] }}">{{ item['desc_item'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label for="observacao">Observação</label><br>
                                    <textarea class="address-observ" id="observacao" name="observacao" placeholder="Observações..."></textarea>
                                </div>
                                <div style="display: flex;width: 100%;">
                                    <input class="subm" style="max-width: none;" type="submit" value="Registrar...">
                                    {% if 'privilegio' in session %}
                                        {% if session['privilegio'] <= 2 %}
                                            <img class="subm" style="height: 30px;width: 30px; padding: 15px;margin-left: 15px" src="{{ url_for('static', filename='icons/pen-to-square.svg') }}" alt="" onclick="toggleEdit()">
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tables-container" id="tables-cont">
                <div class="split-horizontal">
                    <h1>Programação de Envase</h1>
                    <div style="display: flex">
                        <img class="svg-gray" src="{{ url_for('static', filename='icons/clipboard-list.svg') }}" title="Mostrar/Ocultar Formulário" alt="" onclick="toggleContainer()">
                        <img class="svg-gray" src="{{ url_for('static', filename='icons/calendar.svg') }}" alt="" title="Calendário de Envase" onclick="window.location.href='{{ url_for('calendar_envase') }}';">
                        <img class="svg-gray" src="{{ url_for('static', filename='icons/filter.svg') }}" alt="" title="Filtros para a tabela..." onclick="toggleFilter()">
                    </div>
                </div>
                <div style="justify-content: flex-end" >
                    <label for="filterDate"></label>
                    <div id="table-filter" style="position: absolute;display: none;right: 25px" >
                        <div class="back-modal" onclick="toggleFilter()"></div>
                        <div class="form-filter generic" style="z-index: 9999;top: 30%; left: 45%; position: fixed">
                            <div style="padding: 5px;display: flex;max-height: 40px;align-items: center;justify-content: center;">
                                <div class="split-horizontal" style="align-items: center">
                                    <h3 style="font-size: 24px">Filtros</h3>
                                    <div style="scale: 0.7">
                                        <button class="pin" id="fix-move-btn" onclick="toggleFilter()">
                                            <img style="height: 30px;width: 30px" class="svg-gray" src="{{ url_for('static', filename='icons/xmark.svg') }}" alt="">
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div style="padding: 20px;">
                                <p class="cor-web">Data</p>
                                <div class="split-horizontal" style="display: flex;max-height: 40px;border: 0;align-items: center;justify-content: center;">
                                    <div class="split-horizontal">
                                        <input type="date" class="address" id="filterDate" onchange="filterByDate()">
                                        <a class="button-mini subm" style="margin: 0" onclick="getHoje()">
                                            <img class="svg-invert" src="{{ url_for('static', filename='icons/calendar-day.svg') }}" alt="">
                                        </a>
                                        <a class="button-mini subm" style="margin: 0" onclick="limpaData()">
                                            <img class="svg-invert" src="{{ url_for('static', filename='icons/calendar-xmark.svg') }}" alt="">
                                        </a>
                                    </div>
                                </div>
                                <br>
                                <p class="cor-web">Linhas</p>
                                <div style="display: flex; flex-direction: column">
                                    <div>
                                        <input type="checkbox" class="checkbox" id="toggle_linha1" onclick="toggleTable('linha1')" checked>
                                        <label for="toggle_linha1">Linha 1</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" class="checkbox" id="toggle_linha2" onclick="toggleTable('linha2')" checked>
                                        <label for="toggle_linha2">Linha 2</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" class="checkbox" id="toggle_linha3" onclick="toggleTable('linha3')" checked>
                                        <label for="toggle_linha3">Linha 3</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" class="checkbox" id="toggle_linha4" onclick="toggleTable('linha4')" checked>
                                        <label for="toggle_linha4">Linha 4</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" class="checkbox" id="toggle_linha5" onclick="toggleTable('linha5')" checked>
                                        <label for="toggle_linha5">Linha 5</label>
                                    </div>
                                </div>
                                <br>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-overflow section-linhas programmed-l1" id="linha1_table">
                    <h4>Linha 1</h4>
                    <table class="saldoTable">
                        <tr>
                            <th>Cliente (Desc.)</th>
                            <th>Produto (Cód.)</th>
                            <th>Produto (Desc.)</th>
                            <th>Quantidade (Caixa)</th>
                            <th>Data Entrada Antec.</th>
                            <th>Data Envase</th>
                            <th>Concluído</th>
                            <td class="td-more"></td>
                            <td class="td-more"></td>
                        </tr>
                        {% for item in envase %}
                            {% if item['linha'] == 1 %}
                                <tr>
                                    <td style="max-width: 100px;" {% if item['fantasia_cliente']|length > 15 %} title="{{ item['fantasia_cliente'] }}" {% endif %}>
                                        {{ item['fantasia_cliente'] }}
                                    </td>
                                    <td style="width: 80px;">{{ item['cod_item'] }}</td>
                                    <td>{{ item['desc_item'] }}</td>
                                    <td style="width: 100px;">{{ '{:,.0f}'.format(item['quantidade']).replace(',', '.') }}</td>
                                    <td style="width: 80px;">{{ item['data_entr_antec'] }}</td>
                                    <td style="width: 80px;">{{ item['data_envase'] }}</td>
                                    <td class="tb-checkbox">
                                        <input type="checkbox" oninput="confirmConcluir('{{ item['id_envase'] }}', this)" style="width: 16px; height: auto" {% if item['concluido'] %} checked {% endif %} {% if item['concluido'] %} disabled {% endif %}>
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" title="obs.:&#10;{{ item['observacao'] }}">
                                        <img class="svg-gray table-more" style="height: 15px;width: 15px; padding: 2px" src="{{ url_for('static', filename='icons/info.svg') }}" alt="">
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" >
                                        <img class="svg-link table-more" src="{{ url_for('static', filename='icons/edit-link.svg') }}" onclick="redirectToEdit('{{ item['id_envase'] }}')" alt="">
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <br>
                </div>
            <br>
                <div class="table-overflow section-linhas programmed-l2" id="linha2_table">
                    <h4>Linha 2</h4>
                    <table class="saldoTable">
                        <tr>
                            <th>Cliente (Desc.)</th>
                            <th>Produto (Cód.)</th>
                            <th>Produto (Desc.)</th>
                            <th>Quantidade (Caixa)</th>
                            <th>Data Entrada Antec.</th>
                            <th>Data Envase</th>
                            <th>Concluído</th>
                            <td class="td-more"></td>
                            <td class="td-more"></td>
                        </tr>
                        {% for item in envase %}
                            {% if item['linha'] == 2 %}
                                <tr>
                                    <td style="max-width: 100px;" {% if item['fantasia_cliente']|length > 15 %} title="{{ item['fantasia_cliente'] }}" {% endif %}>
                                        {{ item['fantasia_cliente'] }}
                                    </td>
                                    <td style="width: 80px;">{{ item['cod_item'] }}</td>
                                    <td>{{ item['desc_item'] }}</td>
                                    <td style="width: 100px;">{{ '{:,.0f}'.format(item['quantidade']).replace(',', '.') }}</td>
                                    <td style="width: 80px;">{{ item['data_entr_antec'] }}</td>
                                    <td style="width: 80px;">{{ item['data_envase'] }}</td>
                                    <td class="tb-checkbox">
                                        <input type="checkbox" oninput="confirmConcluir('{{ item['id_envase'] }}', this)" style="width: 16px; height: auto" {% if item['concluido'] %} checked {% endif %} {% if item['concluido'] %} disabled {% endif %}>
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" title="obs.:&#10;{{ item['observacao'] }}">
                                        <img class="svg-gray table-more" style="height: 15px;width: 15px; padding: 2px" src="{{ url_for('static', filename='icons/info.svg') }}" alt="">
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" >
                                        <img class="svg-link table-more" src="{{ url_for('static', filename='icons/edit-link.svg') }}" onclick="redirectToEdit('{{ item['id_envase'] }}')" alt="">
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <br>
                </div>
            <br>
                <div class="table-overflow section-linhas programmed-l3" id="linha3_table">
                    <h4>Linha 3</h4>
                    <table class="saldoTable">
                        <tr>
                            <th>Cliente (Desc.)</th>
                            <th>Produto (Cód.)</th>
                            <th>Produto (Desc.)</th>
                            <th>Quantidade (Caixa)</th>
                            <th>Data Entrada Antec.</th>
                            <th>Data Envase</th>
                            <th>Concluído</th>
                            <td class="td-more"></td>
                            <td class="td-more"></td>
                        </tr>
                        {% for item in envase %}
                            {% if item['linha'] == 3 %}
                                <tr>
                                    <td style="max-width: 100px;" {% if item['fantasia_cliente']|length > 15 %} title="{{ item['fantasia_cliente'] }}" {% endif %}>
                                        {{ item['fantasia_cliente'] }}
                                    </td>
                                    <td style="width: 80px;">{{ item['cod_item'] }}</td>
                                    <td>{{ item['desc_item'] }}</td>
                                    <td style="width: 100px;">{{ '{:,.0f}'.format(item['quantidade']).replace(',', '.') }}</td>
                                    <td style="width: 80px;">{{ item['data_entr_antec'] }}</td>
                                    <td style="width: 80px;">{{ item['data_envase'] }}</td>
                                    <td class="tb-checkbox">
                                        <input type="checkbox" oninput="confirmConcluir('{{ item['id_envase'] }}', this)" style="width: 16px; height: auto" {% if item['concluido'] %} checked {% endif %} {% if item['concluido'] %} disabled {% endif %}>
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" title="obs.:&#10;{{ item['observacao'] }}">
                                        <img class="svg-gray table-more" style="height: 15px;width: 15px; padding: 2px" src="{{ url_for('static', filename='icons/info.svg') }}" alt="">
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" >
                                        <img class="svg-link table-more" src="{{ url_for('static', filename='icons/edit-link.svg') }}" onclick="redirectToEdit('{{ item['id_envase'] }}')" alt="">
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <br>
                </div>
            <br>
                <div class="table-overflow section-linhas programmed-l4" id="linha4_table">
                    <h4>Linha 4</h4>
                    <table class="saldoTable">
                        <tr style="width: 100%">
                            <th>Cliente (Desc.)</th>
                            <th>Produto (Cód.)</th>
                            <th>Produto (Desc.)</th>
                            <th>Quantidade (Caixa)</th>
                            <th>Data Entrada Antec.</th>
                            <th>Data Envase</th>
                            <th>Concluído</th>
                            <td class="td-more"></td>
                            <td class="td-more"></td>
                        </tr>
                        {% for item in envase %}
                            {% if item['linha'] == 4 %}
                                <tr>
                                    <td style="width: 100px;" {% if item['fantasia_cliente']|length > 15 %} title="{{ item['fantasia_cliente'] }}" {% endif %}>
                                        {{ item['fantasia_cliente'] }}
                                    </td>
                                    <td style="width: 80px;">{{ item['cod_item'] }}</td>
                                    <td>{{ item['desc_item'] }}</td>
                                    <td style="width: 100px;">{{ '{:,.0f}'.format(item['quantidade']).replace(',', '.') }}</td>
                                    <td style="width: 80px;">{{ item['data_entr_antec'] }}</td>
                                    <td style="width: 80px;">{{ item['data_envase'] }}</td>
                                    <td class="tb-checkbox">
                                        <input type="checkbox" oninput="confirmConcluir('{{ item['id_envase'] }}', this)" style="width: 16px; height: auto" {% if item['concluido'] %} checked {% endif %} {% if item['concluido'] %} disabled {% endif %}>
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" title="obs.:&#10;{{ item['observacao'] }}">
                                        <img class="svg-gray table-more" style="height: 15px;width: 15px; padding: 2px" src="{{ url_for('static', filename='icons/info.svg') }}" alt="">
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" >
                                        <img class="svg-link table-more" src="{{ url_for('static', filename='icons/edit-link.svg') }}" onclick="redirectToEdit('{{ item['id_envase'] }}')" alt="">
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <br>
                </div>
                <br>
                <div class="table-overflow section-linhas programmed-l5" id="linha5_table">
                    <h4>Linha 5</h4>
                    <table class="saldoTable">
                        <tr style="width: 100%">
                            <th>Cliente (Desc.)</th>
                            <th>Produto (Cód.)</th>
                            <th>Produto (Desc.)</th>
                            <th>Quantidade (Caixa)</th>
                            <th>Data Entrada Antec.</th>
                            <th>Data Envase</th>
                            <th>Concluído</th>
                            <td class="td-more"></td>
                            <td class="td-more"></td>
                        </tr>
                        {% for item in envase %}
                            {% if item['linha'] == 5 %}
                                <tr>
                                    <td style="width: 100px;" {% if item['fantasia_cliente']|length > 15 %} title="{{ item['fantasia_cliente'] }}" {% endif %}>
                                        {{ item['fantasia_cliente'] }}
                                    </td>
                                    <td style="width: 80px;">{{ item['cod_item'] }}</td>
                                    <td>{{ item['desc_item'] }}</td>
                                    <td style="width: 100px;">{{ '{:,.0f}'.format(item['quantidade']).replace(',', '.') }}</td>
                                    <td style="width: 80px;">{{ item['data_entr_antec'] }}</td>
                                    <td style="width: 80px;">{{ item['data_envase'] }}</td>
                                    <td class="tb-checkbox">
                                        <input type="checkbox" oninput="confirmConcluir('{{ item['id_envase'] }}', this)" style="width: 16px; height: auto" {% if item['concluido'] %} checked {% endif %} {% if item['concluido'] %} disabled {% endif %}>
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" title="obs.:&#10;{{ item['observacao'] }}">
                                        <img class="svg-gray table-more" style="height: 15px;width: 15px; padding: 2px" src="{{ url_for('static', filename='icons/info.svg') }}" alt="">
                                    </td>
                                    <td class="td-more" data-toggle="tooltip" >
                                        <img class="svg-link table-more" src="{{ url_for('static', filename='icons/edit-link.svg') }}" onclick="redirectToEdit('{{ item['id_envase'] }}')" alt="">
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <br>
                </div>
                <a href="{{ url_for('export_csv_tipo', tipo='envase') }}">
                    Baixar tabela...
                </a>
            </div>
        <script>
            function redirectToEdit(idEnvase) {
                window.location.href = "/envase/edit?id_envase=" + idEnvase;
            }

            $(document).ready(function(){
                $('[data-toggle="tooltip"]').tooltip();
            });

            $(document).ready(function() {
                function getFantasiaClientes() {
                    $.get('/get/clientes', function(data) {
                        data.forEach(function(cliente) {
                            $('#cliente').append('<option>' + cliente.fantasia_cliente + '</option>');
                        });

                        $('#cliente').select2();
                    });
                }
                getFantasiaClientes();
            });

            function buscarLinhas() {
                var item_selec = $("#produto").val();

                $.ajax({
                    type: "POST",
                    url: "/buscar_linhas",
                    data: { produto: item_selec },
                    success: function(response) {

                        $("#linha").empty();

                        if (response.cod_linha.length > 1) {
                            lockIcoHide("label-linha");
                        }

                        response.cod_linha.forEach(function(linha) {
                            $("#linha").append("<option value='" + linha + "'>" + linha + "</option>");
                        });
                    },
                    error: function(error) {
                        console.error("Erro ao buscar as linhas:", error);
                    }
                });
            }

            $("#formBuscarItens").submit(function(event) {
                event.preventDefault();
                buscarItens();
            });

            function buscarItens() {
                var codigo = $("#cod_str_qr").val();

                $.ajax({
                    type: "POST",
                    url: "/searching",
                    data: { cod_str_qr: codigo },
                    success: function(response) {

                        $("#produto").val(response.descITEM);
                        $("#cod_str_qr").val("");
                        $("#codsku").empty();

                        buscarLinhas();

                        if (response.codITEM.length > 1) {
                            lockIcoHide("label-sku");
                        }

                        if (response.codITEM) {
                            response.codITEM.forEach(function(item) {

                                $("#codsku").append("<option value='" + item + "'>" + item + "</option>");
                            });
                        } else {
                            $("#codsku").append("<option value=''></option>");
                        }

                        $("#lote_item").val(response.codLOTE);

                        if (response.codLOTE === "") {
                            lockIcoHide("label-lote")

                            $("#lote_item").prop("readonly", false);
                        } else {

                            $("#lote_item").prop("readonly", true);
                        }
                    },

                    error: function(error) {
                        console.error("Erro ao buscar itens:", error);
                    }
                });
            }

            function confirmConcluir(codEnvase, checkbox) {
                if (confirm("Você tem certeza que deseja concluir esta programação?")) {
                    window.location.href = "/envase/concl/" + codEnvase;
                } else {
                    checkbox.checked = false;
                }
            }

            function filterByDate() {
                const filterDate = document.getElementById('filterDate').value;
                const tables = document.querySelectorAll('.table-overflow');

                tables.forEach(table => {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length > 5) {
                            const dataEnvase = cells[5].textContent.trim();
                            const isVisible = filterDate === '' || dataEnvase === filterDate;

                            row.style.display = isVisible ? 'table-row' : 'none';
                        }
                    });
                });
            }

            function getHoje() {
                const today = new Date();
                document.getElementById('filterDate').value = today.toISOString().split('T')[0];
                filterByDate();
                document.getElementById('filterDate').focus()
            }

            function limpaData() {
                document.getElementById('filterDate').value = "";
                filterByDate();
                document.getElementById('filterDate').focus()
            }

        </script>

    <!-- SUPLEMENTO P/ FILTRO [LB-FILTER] -->
        <script src="{{ url_for('static', filename='js/lb-filter.js') }}"></script>

    {% include 'shared/footer.html' %}