{% extends 'base.j2' %}

{% block title %}Usuários{% endblock title %}

{% block content %}

    <div class="titles-ruler">
        
        {% from 'components/title-route.j2' import title_container %}
        {{ title_container(
            id_page=session['id_page'],
            breadcrumbs=[
                {'text': 'USUÁRIOS'}
            ],
            aux_buttons=[
                {'type': 'link', 'url': 'users', 'icon': 'svg/pen-line.svg', 'title': 'EDITAR USUÁRIOS', 'active': True},
                {'type': 'divider'},
                {'type': 'action', 'icon': 'svg/circle-arrow-left.svg', 'title': 'VOLTAR', 'onclick': 'goBack()'}
            ]
        ) }}
        
    </div>

    <div id="divContent">
        <div draggable="false" class="forms-container" style="display: unset; max-height: 480px; min-height: unset;">
            <form style="justify-content: space-between">
                <h1 class="text-main-color">Editar Usuário</h1>
                {% for item in user_data %}
                    <div style="min-width: 100%">
                        <div>
                            <div style="margin-bottom: 10px; margin-top: 8px;" class="centralizado">
                                <div class="user-button bigger">
                                    {{ item['nome_user'][0] }}{{ item['sobrenome_user'][0] }}
                                </div>
                            </div>
                            <h3>{{ item['nome_user'] }} {{ item['sobrenome_user'] }}</h3>
                            <h4 style="margin-top: 0; margin-bottom: 8px; text-align: center">
                                {{ 'Administrador' if item['privilege_user'] <= 2 else 'Usuário Padrão' }}
                            </h4>
                            <h4 style="margin: 0 0 18px 0; text-align: center; color: #888; font-size: 13px;">
                                Login: {{ item['login_user'] }}
                            </h4>
                        </div>
                    </div>
                    <a style="font-size: 14px" class="hyperlink" onclick="redefinePassword('{{ req_id_user }}')">REDEFINIR SENHA</a>
                    <a class="btn-fancy" href="{{ url_for('users') }}">Voltar</a>
                {% endfor %}
            </form>
        </div>
        <div draggable="false" class="tables-container" style="width: 600px">
            <div style="width: 100%; max-height: 535px;">
                <h1>Permissões do Sistema</h1>
                <div class="table-overflow" style="max-height: 540px;">
                    <table id="filterTable">
                        <tr>
                            <th>Permissão (Cód.)</th>
                            <th>Permissão (Desc.)</th>
                            <th>Acesso</th>
                        </tr>
                        {% for permission in permissions %}
                            <tr>
                                <td>{{ permission['id_perm'] }}</td>
                                <td>{{ permission['desc_perm'] }}</td>
                                <td class="tb-checkbox">
                                    {% if user_perm %}
                                        {% set perm_ids = user_perm|map(attribute='id_perm')|list %}
                                        {% if permission['id_perm'] in perm_ids %}
                                            <input 
                                                checked
                                                type="checkbox" 
                                                class="check" 
                                                oninput="confirmRemover(
                                                    '{{ req_id_user }}',
                                                    '{{ permission['id_perm'] }}', 
                                                    this
                                                )"
                                            >
                                        {% else %}
                                            <input 
                                                type="checkbox" 
                                                class="check" 
                                                oninput="confirmAdicionar(
                                                    '{{ req_id_user }}',
                                                    '{{ permission['id_perm'] }}', 
                                                    this
                                                )"
                                            >
                                        {% endif %}
                                    {% else %}
                                        <input type="checkbox" class="check" oninput="confirmAdicionar('{{ req_id_user }}','{{ permission['id_perm'] }}', this)">
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            <br>
        </div>
    </div>

    {# Password Reset Modal #}
    <div id="passwordModal" class="modal-overlay" onclick="if(event.target === this) Modal.close('passwordModal')">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h2>Redefinir Senha</h2>
                <button class="modal-close" onclick="Modal.close('passwordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label for="newPassword">Nova senha</label>
                    <input type="password" id="newPassword" placeholder="Mínimo 6 caracteres...">
                </div>
                <div class="modal-field">
                    <label for="confirmPassword">Confirmar senha</label>
                    <input type="password" id="confirmPassword" placeholder="Repita a senha...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="Modal.close('passwordModal')">Cancelar</button>
                <button class="modal-btn modal-btn-primary" onclick="submitPassword()">Salvar</button>
            </div>
        </div>
    </div>

{% endblock content %}

{% block route_script %}

    <script>
        let currentUserId = null;

        function redefinePassword(idUser) {
            currentUserId = idUser;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            Modal.open('passwordModal');
        }

        function submitPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 6) {
                Modal.alert('A senha deve ter no mínimo 6 caracteres.');
                return;
            }

            if (newPassword !== confirmPassword) {
                Modal.alert('As senhas não coincidem.');
                return;
            }

            fetch('/api/users/set-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_user: currentUserId,
                    password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Modal.close('passwordModal');
                    Modal.alert('Senha redefinida com sucesso!');
                } else {
                    Modal.alert(data.error || 'Erro ao redefinir senha.');
                }
            })
            .catch(err => {
                console.error('Error:', err);
                Modal.alert('Erro ao redefinir senha.');
            });
        }

        function confirmRemover(idUser, idPerm, checkbox) {
            Modal.confirm("Você tem certeza que deseja remover esta permissão?", () => {
                window.location.href = "/users/remove-perm/" + idUser + "/" + idPerm;
            }, { title: 'Remover Permissão', confirmText: 'Remover', danger: true });

            // Reset checkbox if modal is closed without confirming
            checkbox.checked = true;
        }

        function confirmAdicionar(idUser, idPerm, checkbox) {
            Modal.confirm("Você tem certeza que deseja adicionar esta permissão?", () => {
                window.location.href = "/users/add-perm/" + idUser + "/" + idPerm;
            }, { title: 'Adicionar Permissão', confirmText: 'Adicionar' });

            // Reset checkbox if modal is closed without confirming
            checkbox.checked = false;
        }
    </script>

{% endblock route_script %}