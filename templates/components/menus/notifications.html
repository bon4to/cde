<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <title>Notificações | CDE</title>
        <link rel="icon" href="{{ url_for('static', filename='cde-logo-only.svg') }}" type="image/x-icon">

        {% include 'shared/header/cde-header.html' %}
        <div class="titles-ruler">

            {% from 'components/title-route.html' import title_container %}
            {{ title_container(
                title='NOTIFICAÇÕES',
                id_page=session['id_page'],
                breadcrumbs=[
                    {'text': 'NOTIFICAÇÕES'}
                ],
                aux_buttons=[
                    {'type': 'link', 'url': 'cde_cfg', 'icon': 'svg/cog.svg', 'title': 'AJUSTES'},
                    {'type': 'link', 'url': 'cde_account', 'icon': 'svg/circle-user.svg', 'title': 'USUÁRIO'},
                    {'type': 'divider'},
                    {'type': 'link', 'url': 'about', 'icon': 'svg/circle-help.svg', 'title': 'AJUDA'},
                    {'type': 'divider'},
                    {'type': 'action', 'icon': 'svg/circle-arrow-left.svg', 'title': 'VOLTAR', 'onclick': 'goBack()'}
                ]
            ) }}

        </div>
        <div id="divContent" style="flex-wrap: wrap;">
            
            <div class="tables-container" style="flex: 0; display: flex; justify-content: flex-start; min-width: 30vw;">
                <div style="width: 100%; height: 640px; overflow-x: hidden;">
                    {% for notification in notifications %}
                    <div class="notification-container {% if notification['flag_read'] %}read{% endif %}">
                        <div class="split-h" style="padding: 16px; width: unset;">
                            <div style="margin-right: 14px;">
                                <h2 class="notification-title">{{ notification['title'] }}</h2>
                                <p class="notification-message" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;">{{ notification['message'] }}</p>
                            </div>
                            <div class="notification-icons">
                                {% if not notification['flag_read'] %}
                                <img class="notification-icon" src="{{ url_for('static', filename='svg/mail-open.svg') }}" title="Marcar como lida" onclick="clearNotification({{ session['id_user'] }}, {{ notification['id'] }})">
                                {% endif %}
                                <img class="notification-icon" src="{{ url_for('static', filename='svg/open.svg') }}" title="Abrir" onclick="window.location.href='{{ url_for('cde_notifications_id', id_notification=notification['id']) }}'">
                            </div>
                        </div>
                        <p class="notification-date">{{ notification['date'] }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% if notification %}
            {% set notification = notification[0] %}
            <div class="tables-container" style="flex: 0; display: flex; justify-content: flex-start; min-width: 40vw;">
                <div class="split-v" style="width: 100%;">

                    <div style="width: 100%; height: 640px; overflow-x: hidden;">
                        <div style="padding: 16px; padding-top: 30px">
                        <p class="notification-date">{{ notification['date'] }}</p>
                            <div class="split-h">
                                <h2 class="notification-title" style="font-size: 24px; margin-top: 0">{{ notification['title'] }}</h2>
                            </div>
                            <p class="notification-message"  style="font-size: 16px">{{ notification['message'] }}</p>
                        </div>
                    </div>
                    
                    <!-- TODO: Adicionar botoes de (voltar, editar, excluir) -->

                    <div class="flex-h" style="width: 100%; justify-content: flex-end;">
                        <div class="button-mini btn-fancy" onclick="clearNotification({{ session['id_user'] }}, {{ notification['id'] }})" title="Marcar como lida" >
                            <img class="svg-invert" src="{{ url_for('static', filename='svg/mail-open.svg') }}" alt="">
                        </div>
                        <div class="button-mini btn-fancy" onclick="window.location.href='{{ url_for('cde_notifications') }}'" title="Fechar" >
                            <img class="svg-invert" src="{{ url_for('static', filename='svg/xmark.svg') }}" alt="">
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
                <div draggable="false" class="forms-container" style="position: relative; max-width: max-content">
                    <form id="formSetNotification" method="post" style="display: block; height: unset">
                        <div>
                            <h2>Enviar Notificação</h2>
                            <div class="split-h">
                                <input class="address-one" type="text" id="title" maxlength="180" name="title" required placeholder="Título...">
                                <input class="address-four" type="number" id="userid" max="999" name="userid" placeholder="ID..." title="ID do usuário" min="0">
                            </div>
                            <textarea class="address-observ" id="message" maxlength="180" name="message" required placeholder="Mensagem..."></textarea>
                            <button type="submit" class="btn-fancy">
                                <img class="svg-invert" src="{{ url_for('static', filename='svg/send.svg') }}" alt="Enviar">
                            </button>
                        </div>
                    </form>
                </div>
            {% endif %}
        </div>

{% include 'shared/footer.html' %}

<script>
    document.getElementById('formSetNotification').addEventListener('submit', function(event) {
        event.preventDefault();

        let iduser = document.getElementById('userid').value;
        let title = document.getElementById('title').value;
        let message = document.getElementById('message').value;

        fetch('/api/notification/set/', {
            method: 'POST',
            body: JSON.stringify({ iduser, title, message }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            showToast('Notificação enviada com sucesso! Recarregando...', 1, 2);
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro ao enviar notificação.', 3, 2);
        });
    });

    function clearNotification(iduser, id) {
        fetch('/api/notification/clear/', {
            method: 'POST',
            body: JSON.stringify({ iduser, id }),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            window.location.reload();
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro ao marcar notificação como lida.', 3, 2);
        });
    }
</script>